<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" 
	  xmlns:ui="http://java.sun.com/jsf/facelets" 
	  xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://java.sun.com/jsp/jstl/core">
<h:head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>TMS Tables</title>
<style>
	.tmsHeaderGrid.ui-panelgrid>*>tr,
	.tmsHeaderGrid.ui-panelgrid .ui-panelgrid-cell 
	{
	    border: none;
	}
	.toolBarGrid.ui-panelgrid>*>tr,
	.toolBarGrid.ui-panelgrid>*>td,
	.toolBarGrid.ui-panelgrid .ui-panelgrid-cell 
	{
		padding: 0px;
		padding-top: 5px;
		padding-left: 1px;
		border: none;
	    margin: 0px auto;
	    background-color: transparent !important;
	}
	.tmsActionBtn
	{
		width: 20px;
		height: 20px;
		margin: 0px;
		padding: 0px;
	}
</style>
</h:head>
<h:body>
<h:form id="rename">
    <p:dialog id="renameTEDialog" 
    		  header="Rename #{tableEdit.entityTag}" 
    		  widgetVar="renameTEDialog" 
    		  modal="true" 
    		  resizable="false" 
              showEffect="clip" 
              hideEffect="fold" >  
	    <p:panelGrid id="renameTEPanel" columns="2" cellpadding="4" styleClass="tmsHeaderGrid">
	        <p:outputLabel value="#{tableEdit.entityTag} Name: " />  
	        <p:inputText id="txRenameTE" value="#{tableEdit.entityLabel}" widgetVar="newName"/>
	        <p:commandButton icon="ui-icon-check"   
	        				 value="OK" 
	        				 oncomplete="PF('renameTEDialog').hide()"
	        				 process="@form"
	        				 update=":form:tableEditorId"
	        				 onstart="$('rename').submit();"
	        				 />
			<p:commandButton icon="ui-icon-cancel" value="Cancel" type="button" onclick="PF('renameTEDialog').hide()"/>
		</p:panelGrid>  
    </p:dialog>
</h:form>

<h:form id="derive">
    <p:dialog id="deriveTEDialog" 
    		  header="Set #{tableEdit.entityTag} Derivation" 
    		  widgetVar="deriveTEDialog" 
    		  modal="true" 
    		  resizable="false" 
              showEffect="clip" 
              hideEffect="fold">  
	    <p:panelGrid id="deriveTEPanel" columns="2" cellpadding="4" styleClass="tmsHeaderGrid">
	        <p:outputLabel value="#{tableEdit.entityTag} Derivation: "/>  
	        <p:inputText id="txDeriveTE" value="#{tableEdit.entityDerivation}" widgetVar="newDeriv" size="30" styleClass="txDeriveTE"/> 
	        <p:outputLabel value="Update Every: " for="minMax"/>  
			<p:spinner id="minMax" value="#{tableEdit.updateEvery}" min="0" max="100" suffix=" seconds"/>
		</p:panelGrid>  
	    <p:panelGrid id="deriveTEPanel2" columns="3" cellpadding="4" styleClass="tmsHeaderGrid">
	        <p:commandButton icon="ui-icon-check"   
	        				 value="OK" 
	        				 actionListener="#{tableEdit.applyDerivation}"
	        				 oncomplete="PF('deriveTEDialog').hide()"
	        				 update=":form:tableEditorId"
	        				 process="@form"
	        				 />
	        <p:commandButton icon="ui-icon-arrowthickstop-1-w"   
	        				 value="Clear" 
	        				 onclick="$('.txDeriveTE').val('')"
	        				 process="@form"
	        				 immediate="true"
	        				 ajax="false"
	        				 type="button"
	        				 />
			<p:commandButton icon="ui-icon-cancel" value="Cancel" type="button" onclick="PF('deriveTEDialog').hide()"/>
		</p:panelGrid>  
   </p:dialog>
</h:form>

<h:form id="format">
    <p:dialog id="formatTEDialog" 
    		  header="Set #{tableEdit.entityTag} Format" 
    		  widgetVar="formatTEDialog" 
    		  modal="true" 
    		  resizable="false" 
              showEffect="clip" 
              hideEffect="fold">  
	    <p:panelGrid id="deriveTEPanel" columns="2" cellpadding="4" styleClass="tmsHeaderGrid">
	        <p:outputLabel value="#{tableEdit.entityTag} Format: " />  
	        <p:inputText id="txFormatTE" value="#{tableEdit.entityFormat}" widgetVar="newFormat" size="20"/> 
	        <p:commandButton icon="ui-icon-check"   
	        				 value="OK" 
	        				 oncomplete="PF('formatTEDialog').hide()"
	        				 update=":form:tableEditorId"
	        				 process="@form"
	        				 onstart="$('#format').submit();"
	        				 />
			<p:commandButton icon="ui-icon-cancel" value="Cancel" type="button" onclick="PF('formatTEDialog').hide()"/>
		</p:panelGrid>  
   </p:dialog>
</h:form>

<h:form id="gScript" enctype="multipart/form-data">
    <p:remoteCommand name="onScriptTypeChange" update=":gScript:fileUpload" actionListener="#{tableEdit.recalc}"/>
	<p:dialog id="scriptTEDialog" 
    		  header="Upload New Operators" 
    		  widgetVar="scriptTEDialog" 
    		  modal="true" 
    		  resizable="false" 
              showEffect="clip"
              hideEffect="fold">  
	    <p:panelGrid id="scriptTEPanel" columns="2" cellpadding="4" styleClass="tmsHeaderGrid">
	        <p:outputLabel value="Script File: "/>  
 			<p:fileUpload id="fileUpload"
 						  widgetVar="fileUploadP"
 						  fileUploadListener="#{tableEdit.uploadOps}"
 						  value="#{tableEdit.file}" 
 						  mode="advanced"
 						  dragDropSupport="true"
 						  fileLimit="1" 
 						  allowTypes="#{tableEdit.filePattern}"
 						  update="uploadMessages"/>
		</p:panelGrid>  
	    <p:panelGrid  columns="3" cellpadding="4" styleClass="tmsHeaderGrid" >
          <p:outputLabel for="format" value="Format" />
          <p:selectOneRadio id="scriptType" value="#{tableEdit.scriptType}" immediate="true" valueChangeListener="#{tableEdit.scriptTypeChanged}" onchange="onScriptTypeChange()">
            <f:selectItem itemLabel="Groovy" itemValue="Groovy" />
            <f:selectItem itemLabel="P/Jython" itemValue="Python" />
          </p:selectOneRadio>
   		  <p:commandButton icon="ui-icon-check" value="Done" type="button" onclick="PF('scriptTEDialog').hide()"/>
	    </p:panelGrid>
		<p:growl id="uploadMessages" showDetail="true" />	
   </p:dialog>
</h:form>

<h:form id="gLoadTable" enctype="multipart/form-data">
    <p:remoteCommand name="onTableLoad" update=":form:tableEditorId"/>
	<p:dialog id="loadTEDialog" 
    		  header="Load Saved Table" 
    		  widgetVar="loadTEDialog" 
    		  modal="true" 
    		  resizable="false" 
              showEffect="clip"
              hideEffect="fold">  
	    <p:panelGrid id="loadTEPanel" columns="2" cellpadding="4" styleClass="tmsHeaderGrid">
	        <p:outputLabel value="Table File: "/>  
 			<p:fileUpload id="tableUpload"
 						  widgetVar="tableUploadP"
 						  fileUploadListener="#{tableEdit.uploadTable}"
 						  value="#{tableEdit.tableFile}" 
 						  mode="advanced"
 						  dragDropSupport="true"
 						  fileLimit="1" 
 						  allowTypes="/(\.|\/)(tms)$/"
 						  update="tableLoadMessages"/>
   		    <p:commandButton icon="ui-icon-check" value="Done" type="button" onclick="PF('loadTEDialog').hide();onTableLoad();" update=":form:tableEditorId"/>
   		    <p:outputLabel value=""/>
		</p:panelGrid>  
		<p:growl id="tableLoadMessages" showDetail="true" />	
   </p:dialog>
</h:form>

<h:form id="form">
	<script type="text/javascript">
	function startDownload() {
	    PF('statusDialog').show();
	}
	 
	function stopDownload() {
	    PF('statusDialog').hide();
	}
	</script>
   <p:growl id="msgs" showDetail="true"/>
   
	<p:dialog modal="true" widgetVar="statusDialog" header="Status" draggable="false" closable="false" resizable="false">
	    <p:graphicImage value="/ajaxloadingbar.gif" />
	</p:dialog>

   <p:confirmDialog id="deleColDlg" message="Do you really want to delete this column?" 
                     header="Delete Column: #{tableEdit.selectedEntity.label}" severity="alert" widgetVar="deleteColDialog" >
        <p:commandButton id="confirmCD" value="Yes" update=":form:tableEditorId" oncomplete="PF('deleteColDialog').hide()" 
                         actionListener="#{tableEdit.deleteColumn}" />  
        <p:commandButton id="declineCD" value="No" onclick="PF('deleteColDialog').hide()" type="button" />  
   </p:confirmDialog>   
     
   <p:confirmDialog id="deleRowDlg" message="Do you really want to delete this row?" 
                     header="Delete Row: #{tableEdit.selectedEntity.label}" severity="alert" widgetVar="deleteRowDialog" >
        <p:commandButton id="confirmRD" value="Yes" update=":form:tableEditorId" oncomplete="PF('deleteRowDialog').hide()" 
                         actionListener="#{tableEdit.deleteRow}" />  
        <p:commandButton id="declineRD" value="No" onclick="PF('deleteRowDialog').hide()" type="button" />  
   </p:confirmDialog>  
    
   <p:remoteCommand name="onCellEdit" update="@form" />
   <p:dataTable id="tableEditorId"
   				 var="row" 
   				 value="#{tableEdit.rows}" 
   				 editable="true"
   				 editMode="cell" 
   				 widgetVar="tableCell" 
   				 resizableColumns="true" 
   				 liveResize="true"
   				 scrollable="true"
   				 stickyHeader="true" 
   				 >
       <f:facet name="header">
           <p:outputLabel value="#{tableView.title}" style="font-weight:bold;font-size:125%"/>
 	   </f:facet>
       <p:ajax event="cellEdit" oncomplete="onCellEdit()" />
 
       <p:column styleClass="ui-widget-header" width="105">
            <f:facet name="header">
	    	  <p:panelGrid id="btnPanel" columns="5" styleClass="toolBarGrid" >
        		<p:commandButton id="resetTable" icon="ui-icon-refresh" title="New Table" update=":form:tableEditorId" actionListener="#{tableEdit.reset}" styleClass="tmsActionBtn"/>  
        		<p:commandButton id="fileOpen" icon="ui-icon-folder-open" title="Load Table" update=":form:tableEditorId" oncomplete="PF('loadTEDialog').show();" styleClass="tmsActionBtn"/>  
        		<p:commandButton id="fileSave" icon="ui-icon-disk" title="Save Table" ajax="false" onclick="PrimeFaces.monitorDownload(startDownload, stopDownload);" styleClass="tmsActionBtn">
        			<p:fileDownload value="#{tableEdit.savedFile}" contentDisposition="attachment"/>
        		</p:commandButton>  
        		<p:commandButton id="recalcAll" icon="ui-icon-calculator" title="Recalculate All" update=":form:tableEditorId" actionListener="#{tableEdit.recalc}" styleClass="tmsActionBtn"/>  
        		<p:commandButton id="scriptOps" icon="ui-icon-script" title="Load Operators" update=":gScript:fileUpload" oncomplete="PF('scriptTEDialog').show();" styleClass="tmsActionBtn"/>  
			  </p:panelGrid>
            </f:facet>
			<p:outputLabel id="rowNames" value="#{row.label}" style="font-weight:bold;"/>
	        <h:outputText value="*" rendered="#{row.derived}" />
			<p:contextMenu for="rowNames" style="font-size:12px!important; text-align:left!important; margin-left: 0px!important;">
				<p:menuitem  value="Derive..." icon="ui-icon-calculator" oncomplete="PF('deriveTEDialog').show();" update=":derive:deriveTEDialog">
      				<f:setPropertyActionListener value="#{row}" target="#{tableEdit.selectedRow}" />
      			</p:menuitem>
				<p:menuitem  value="Rename..." icon="ui-icon-pencil" oncomplete="PF('renameTEDialog').show();" update=":rename:renameTEDialog">
      				<f:setPropertyActionListener value="#{row}" target="#{tableEdit.selectedRow}" />
      			</p:menuitem>
				<p:menuitem  value="Clear" icon="ui-icon-close" actionListener="#{tableEdit.clearRow(row)}" update="@form"/>
				<p:menuitem  value="Insert" icon="ui-icon-plus" actionListener="#{tableEdit.addRow(row)}" update="@form"/>
	        	<p:menuitem  value="Delete..." icon="ui-icon-trash" oncomplete="PF('deleteRowDialog').show()" update=":form:deleRowDlg">
      				<f:setPropertyActionListener value="#{row}" target="#{tableEdit.selectedRow}" />
	        	</p:menuitem>
			</p:contextMenu>
       </p:column>
       
       <c:forEach items="#{tableEdit.columns}" var="col">
          <p:column id="col_#{col.index}" >
            <f:facet name="header">
                <h:outputText value="#{col.label}"/>
                <h:outputText value="*" rendered="#{col.derived}" />
		        <p:contextMenu for="col_#{col.index}" style="font-size:12px!important; text-align:left!important; margin-left: 0px!important;">
					<p:menuitem  value="Derive..." icon="ui-icon-calculator" oncomplete="PF('deriveTEDialog').show();" update=":derive:deriveTEDialog">
	      				<f:setPropertyActionListener value="#{col}" target="#{tableEdit.selectedColumn}" />
	      			</p:menuitem>
		        	<p:menuitem  value="Rename..." icon="ui-icon-pencil" oncomplete="PF('renameTEDialog').show();" update=":rename:renameTEDialog">
	      				<f:setPropertyActionListener value="#{col}" target="#{tableEdit.selectedColumn}" />
	      			</p:menuitem>
					<p:menuitem  value="Format..." icon="ui-icon-wrench" oncomplete="PF('formatTEDialog').show();" update=":format:formatTEDialog">
	      				<f:setPropertyActionListener value="#{col}" target="#{tableEdit.selectedColumn}" />
	      			</p:menuitem>
		        	<p:menuitem  value="Clear" icon="ui-icon-close" actionListener="#{tableEdit.clearColumn(col)}" update="@form"/>
		        	<p:menuitem  value="Insert" icon="ui-icon-plus" actionListener="#{tableEdit.addColumn(col)}" update="@form"/>
		        	<p:menuitem  value="Delete..." icon="ui-icon-trash" oncomplete="PF('deleteColDialog').show()" update=":form:deleColDlg">
	      				<f:setPropertyActionListener value="#{col}" target="#{tableEdit.selectedColumn}" />
		        	</p:menuitem>
		        </p:contextMenu>
   		   	 <p:tooltip id="colDerivTip" for="col_#{col.index}" value="#{col.derivation}" rendered="#{col.derived}"/>
            </f:facet>
          	<p:cellEditor>
               <f:facet name="output"><div align="center"><h:outputText value="#{col.formattedValue}" style="#{col.style}"/></div></f:facet>
               <f:facet name="input"><p:inputText value="#{col.rawValue}" style="width:96%"/></f:facet>
            </p:cellEditor>
       	  </p:column>
       </c:forEach>
	</p:dataTable>  	
</h:form>

<p:socket channel="/tableUpdated" >
	<p:ajax event="message" update="form:tableEditorId"/>
</p:socket>

</h:body>
</html>